name: Conversion Request

on:
  issues:
    types: [labeled]

jobs:
  get-pack-info:
    runs-on: ubuntu-24.04
    if: github.event.label.name == 'conversion'
    permissions:
      issues: read
    timeout-minutes: 2

    outputs:
      pack_url: ${{ steps.organize.outputs.pack_url }}
      default_pack_url: ${{ steps.organize.outputs.default_pack_url }}
      merge_pack_url: ${{ steps.organize.outputs.merge_pack_url }}
      default_assets_version: ${{ steps.organize.outputs.default_assets_version }}
      block_material: ${{ steps.organize.outputs.block_material }}
      attachable_material: ${{ steps.organize.outputs.attachable_material }}
      archive_scratch: ${{ steps.organize.outputs.archive_scratch }}
      rename_model_files: ${{ steps.organize.outputs.rename_model_files }}
      font_conversion: ${{ steps.organize.outputs.font_conversion }}
      armor_conversion: ${{ steps.organize.outputs.armor_conversion }}
      meg3_fix: ${{ steps.organize.outputs.meg3_fix }}
      sounds_conversion: ${{ steps.organize.outputs.sounds_conversion }}
      bow_conversion: ${{ steps.organize.outputs.bow_conversion }}
      shield_conversion: ${{ steps.organize.outputs.shield_conversion }}
      block_conversion: ${{ steps.organize.outputs.block_conversion }}

    steps:
      - name: Parse Form
        id: parse
        uses: zentered/issue-forms-body-parser@v2.2.0

      - name: Organize Inputs
        id: organize
        run: |
            cat << 'EOF' > raw.json
            ${{ steps.parse.outputs.data }}
            EOF
            jq '{
              pack_url: .["java-pack-direct-download-url"].text,
              default_pack_url: (.["default-pack-direct-download-url"].text // "null"),
              merge_pack_url: (.["bedrock-merge-pack-direct-download-url"].text // "null"),
              default_assets_version: (.["default-assets-version"].text // "1.19.3"),
              block_material: (.["block-material"].text // "alpha_test"),
              attachable_material: (.["attachable-material"].text // "entity_alphatest_one_sided"),
              archive_scratch: (.["archive-scratch-files"].text // "false"),
              rename_model_files: (.["rename-model-files"].text // "false"),
              font_conversion: (.["font-conversion"].text // "true"),
              armor_conversion: (.["armor-conversion"].text // "true"),
              meg3_fix: (.["meg3-fix"].text // "false"),
              sounds_conversion: (.["sounds-conversion"].text // "true"),
              bow_conversion: (.["bow-conversion"].text // "true"),
              shield_conversion: (.["shield-conversion"].text // "true"),
              block_conversion: (.["block-conversion"].text // "true")
            }' raw.json > inputs.json


            for key in pack_url default_pack_url merge_pack_url default_assets_version block_material attachable_material archive_scratch rename_model_files font_conversion armor_conversion meg3_fix sounds_conversion bow_conversion shield_conversion block_conversion; do
              echo "$key=$(jq -r .$key inputs.json)" >> $GITHUB_OUTPUT
            done


  convert-pack:
    runs-on: ubuntu-24.04
    needs: get-pack-info
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      # ------------------------------
      # NODE + PIP + APT CACHE
      # ------------------------------
      - name: Cache APT
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-cache

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      # ------------------------------
      # INSTALL DEPENDENCIES (FAST)
      # ------------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip imagemagick parallel
          pip install Pillow requests jproperties
          yarn global add spritesheet-js


      # ------------------------------
      # DEFAULT ASSETS CACHE
      # ------------------------------
      - name: Cache default assets
        uses: actions/cache@v4
        with:
          path: staging/default_assets.zip
          key: default-assets-${{ needs.get-pack-info.outputs.default_assets_version }}

      # ------------------------------
      # CONVERT PACK
      # ------------------------------
      - name: Convert Pack
        env:
          PACK_URL: ${{ needs.get-pack-info.outputs.pack_url }}
          DEFAULT_PACK_URL: ${{ needs.get-pack-info.outputs.default_pack_url }}
          MERGE_PACK_URL: ${{ needs.get-pack-info.outputs.merge_pack_url }}
          BLOCK_MATERIAL: ${{ needs.get-pack-info.outputs.block_material }}
          ATTACHABLE_MATERIAL: ${{ needs.get-pack-info.outputs.attachable_material }}
          DEFAULT_ASSETS_VERSION: ${{ needs.get-pack-info.outputs.default_assets_version }}
          RENAME_MODEL_FILES: ${{ needs.get-pack-info.outputs.rename_model_files }}
          ARCHIVE_SCRATCH: ${{ needs.get-pack-info.outputs.archive_scratch }}
        run: |
          mkdir -p staging
          cp converter.sh staging/
          cd staging

          chmod +x converter.sh

          curl --compressed -L -o input_pack.zip "$PACK_URL"

          if [ "$MERGE_PACK_URL" != "null" ]; then
            curl --compressed -L -o merge_pack.zip "$MERGE_PACK_URL"
            MERGE_PACK="merge_pack.zip"
          else
            MERGE_PACK="null"
          fi

          ./converter.sh input_pack.zip \
            -w "false" \
            -m "$MERGE_PACK" \
            -a $ATTACHABLE_MATERIAL \
            -b $BLOCK_MATERIAL \
            -f $DEFAULT_PACK_URL \
            -v $DEFAULT_ASSETS_VERSION \
            -r $RENAME_MODEL_FILES \
            -s $ARCHIVE_SCRATCH \
            -u "true"

      # ------------------------------
      # SEND RESULTS TO CONTROLLER
      # ------------------------------
      - name: Zip and Upload To Controller
        run: |
          cd staging/target
          zip -r PackFiles.zip .

          curl -X POST "http://kaizermc.thddns.net:9551/upload_pack" \
            -F "pack=@PackFiles.zip"

          curl -X POST "http://kaizermc.thddns.net:9551/notify/convert_done" \
            -H "Content-Type: application/json" \
            -d '{"status":"done"}'


  post-result:
    runs-on: ubuntu-24.04
    needs: convert-pack
    permissions:
      issues: write

    steps:
      - name: Comment + Close Issue
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ### âœ… Conversion Finished!
            The pack has been processed and uploaded to your controller.
            Your server now has the latest converted pack.
          reactions: rocket

      - uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ github.event.issue.number }}
