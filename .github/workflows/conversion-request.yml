name: Conversion Request

on:
  issues:
    types:
      - labeled
  workflow_dispatch:
    inputs:
      pack_url:
        description: "URL for Java Pack"
        required: false
        default: "null"
      default_pack_url:
        description: "URL for Default Pack"
        required: false
        default: "null"
      merge_pack_url:
        description: "URL for Bedrock Merge Pack"
        required: false
        default: "null"
      default_assets_version:
        description: "Default assets version"
        required: false
        default: "1.19.3"
      block_material:
        description: "Block material type"
        required: false
        default: "alpha_test"

jobs:
  get-pack-info:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.label.name == 'conversion' || github.event_name == 'workflow_dispatch'
    permissions:
      issues: read
    timeout-minutes: 2
    outputs:
      pack_url: ${{ steps.organize-inputs.outputs.PACK_URL }}
      default_pack_url: ${{ steps.organize-inputs.outputs.DEFAULT_PACK_URL }}
      merge_pack_url: ${{ steps.organize-inputs.outputs.MERGE_PACK_URL }}
      default_assets_version: ${{ steps.organize-inputs.outputs.DEFAULT_ASSETS_VERSION }}
      block_material: ${{ steps.organize-inputs.outputs.BLOCK_MATERIAL }}
    steps:
      - name: Issue Forms Body Parser
        id: parse-issue
        uses: zentered/issue-forms-body-parser@v2.2.0
      - name: Organize Inputs
        id: organize-inputs
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo '{ 
              "java-pack-direct-download-url": {"text": "${{ github.event.inputs.pack_url }}"},
              "default-pack-direct-download-url": {"text": "${{ github.event.inputs.default_pack_url }}"},
              "bedrock-merge-pack-direct-download-url": {"text": "${{ github.event.inputs.merge_pack_url }}"},
              "default-assets-version": {"text": "${{ github.event.inputs.default_assets_version }}"},
              "block-material": {"text": "${{ github.event.inputs.block_material }}"}
            }' > inputs.json
          else
            echo ${{ toJSON(steps.parse-issue.outputs.data) }} | jq '
            def test_input($input; $default):
            if ($input == "*No response*" or $input == "None") then $default else ($input | tostring | gsub("\\";""))  end;
            {
              "pack_url": .["java-pack-direct-download-url"].text[1:-1],
              "default_pack_url": test_input(.["default-pack-direct-download-url"].text; " null ")[1:-1],
              "merge_pack_url": test_input(.["bedrock-merge-pack-direct-download-url"].text; " null ")[1:-1],
              "default_assets_version": test_input(.["default-assets-version"].text; "1.19.3"),
              "block_material": test_input(.["block-material"].text; "alpha_test")
            }' > inputs.json
          fi
          echo "PACK_URL=$(jq -r '.pack_url' inputs.json)" >> $GITHUB_OUTPUT
          echo "DEFAULT_PACK_URL=$(jq -r '.default_pack_url' inputs.json)" >> $GITHUB_OUTPUT
          echo "MERGE_PACK_URL=$(jq -r '.merge_pack_url' inputs.json)" >> $GITHUB_OUTPUT
          echo "DEFAULT_ASSETS_VERSION=$(jq -r '.default_assets_version' inputs.json)" >> $GITHUB_OUTPUT
          echo "BLOCK_MATERIAL=$(jq -r '.block_material' inputs.json)" >> $GITHUB_OUTPUT

  convert-pack:
    runs-on: ubuntu-latest
    needs: get-pack-info
    permissions:
      contents: read
    timeout-minutes: 90
    outputs:
      run_id: ${{ steps.get-pack-info.outputs.pack_url }}
    steps:
      - uses: actions/checkout@v4
      - name: Install required dependencies
        run: |
          sudo apt-get install -y zip jq
          yarn global add spritesheet-js
          pip install Pillow requests jproperties
      - name: Execute conversion
        id: convert-pack
        run: |
          mkdir -p staging
          cp converter.sh staging/
          cd staging
          chmod +x converter.sh
          curl -L -o input_pack.zip "${{ needs.get-pack-info.outputs.pack_url }}"
          ./converter.sh input_pack.zip -w false

  post-result:
    runs-on: ubuntu-latest
    needs: convert-pack
    timeout-minutes: 2
    permissions:
      issues: write
    steps:
      - name: Post Results to Issue
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## :sparkles: The run has finished! :sparkles:
            - Pack file conversion has completed successfully.
            - Check artifacts or logs for results.
          reactions: 'rocket'

  conversion-failed:
    runs-on: ubuntu-latest
    needs: [get-pack-info, convert-pack]
    if: always()
    permissions:
      issues: write
    steps:
      - name: Post failure message
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ‚ùå Conversion Failed
            The pack conversion failed during execution.
            - Please review the action logs for more details.
          reactions: 'x'
