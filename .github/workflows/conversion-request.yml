name: Conversion Request

on:
  issues:
    types:
      - labeled

jobs:
  get-pack-info:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'conversion'
    permissions:
      issues: read
    timeout-minutes: 2

    outputs:
      pack_url: ${{ steps.organize-inputs.outputs.PACK_URL }}
      default_pack_url: ${{ steps.organize-inputs.outputs.DEFAULT_PACK_URL }}
      merge_pack_url: ${{ steps.organize-inputs.outputs.MERGE_PACK_URL }}
      default_assets_version: ${{ steps.organize-inputs.outputs.DEFAULT_ASSETS_VERSION }}
      block_material: ${{ steps.organize-inputs.outputs.BLOCK_MATERIAL }}
      attachable_material: ${{ steps.organize-inputs.outputs.ATTACHABLE_MATERIAL }}
      archive_scratch: ${{ steps.organize-inputs.outputs.ARCHIVE_SCRATCH }}
      rename_model_files: ${{ steps.organize-inputs.outputs.RENAME_MODEL_FILES }}
      font_conversion: ${{ steps.organize-inputs.outputs.FONT_CONVERSION }}
      armor_conversion: ${{ steps.organize-inputs.outputs.ARMOR_CONVERSION }}
      meg3_fix: ${{ steps.organize-inputs.outputs.MEG3_FIX }}
      sounds_conversion: ${{ steps.organize-inputs.outputs.SOUNDS_CONVERSION }}
      bow_conversion: ${{ steps.organize-inputs.outputs.BOW_CONVERSION }}
      shield_conversion: ${{ steps.organize-inputs.outputs.SHIELD_CONVERSION }}
      block_conversion: ${{ steps.organize-inputs.outputs.BLOCK_CONVERSION }}

    steps:
      - name: Issue Forms Body Parser
        id: parse-issue
        uses: zentered/issue-forms-body-parser@v2.2.0

      - name: Organize Inputs
        id: organize-inputs
        run: |
          echo ${{ toJSON(steps.parse-issue.outputs.data) }} | jq '
          def norm($v): if ($v|type=="array") then ($v[0]//"") else ($v//"") end;
          def test($in;$def): if (norm($in)=="" or norm($in)=="*No response*") then $def else norm($in) end;
          {
            pack_url: (.["java-pack-direct-download-url"].text | gsub("[<>]"; "")),
            default_pack_url: (test(.["default-pack-direct-download-url"].text;"null") | gsub("[<>]"; "")),
            merge_pack_url: (test(.["bedrock-merge-pack-direct-download-url"].text;"null") | gsub("[<>]"; "")),
            default_assets_version: test(.["default-assets-version"].text;"1.19.3"),
            block_material: test(.["block-material"].text;"alpha_test"),
            attachable_material: test(.["attachable-material"].text;"entity_alphatest_one_sided"),
            archive_scratch: test(.["archive-scratch-files"].text;"false"),
            rename_model_files: test(.["rename-model-files"].text;"false"),
            font_conversion: test(.["font-conversion"].text;"true"),
            armor_conversion: test(.["armor-conversion"].text;"true"),
            meg3_fix: test(.["meg3-fix"].text;"false"),
            sounds_conversion: test(.["sounds-conversion"].text;"true"),
            bow_conversion: test(.["bow-conversion"].text;"true"),
            shield_conversion: test(.["shield-conversion"].text;"true"),
            block_conversion: test(.["block-conversion"].text;"true")
          }' > inputs.json

          while IFS="=" read -r k v; do
            echo "$k=$v" >> $GITHUB_OUTPUT
          done < <(jq -r 'to_entries|.[]|"\(.key|ascii_upcase)=\(.value)"' inputs.json)

  convert-pack:
    runs-on: ubuntu-latest
    needs: get-pack-info
    permissions:
      contents: read
    timeout-minutes: 90

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ‚ö° ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤

      # ‚ö° Optimize: Cache Python dependencies
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: pip-${{ runner.os }}-

      # ‚ö° Optimize: Cache yarn global add
      - name: Cache yarn
        uses: actions/cache@v4
        with:
          path: ~/.cache/yarn
          key: yarn-${{ runner.os }}

      # ‚ö° Optimize: Cache default assets
      - name: Default assets cache
        uses: actions/cache@v4
        with:
          path: |
            staging/default_assets.zip
          key: default-assets-${{ needs.get-pack-info.outputs.default_assets_version }}

      - name: Install NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: 20


      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'


      - name: Install System Dependencies (FAST)
        run: sudo apt-get install -y imagemagick moreutils zip

      # ‚ö° Faster install (cached)
      - name: Install Python & Yarn Dependencies
        run: |
          pip install Pillow requests jproperties --upgrade
          yarn global add spritesheet-js

      - name: Convert Pack
        run: |
          mkdir -p staging
          cp converter.sh staging/
          cd staging
          chmod +x converter.sh
      
          echo "‚¨áÔ∏è Downloading Java pack‚Ä¶"
          curl -fSL -o input_pack.zip "$PACK_URL"
      
          if [ ! -s input_pack.zip ]; then
            echo "‚ùå ERROR: Java pack file is empty or corrupted!"
            exit 1
          fi
      
          echo "üì¶ Extracting ZIP‚Ä¶"
          unzip -qq input_pack.zip -d extracted || {
            echo "‚ùå ERROR: Cannot extract ZIP"
            exit 1
          }
      
          # üü¶üü¶üü¶üü¶üü¶ CHECK FILES INSIDE ZIP HERE üü¶üü¶üü¶üü¶üü¶
          echo "üîç Checking for protected/corrupted textures‚Ä¶"
      
          BAD_COUNT=0
          find extracted -type f \( -iname "*.png" -o -iname "*.jpg" \) | while read f; do
            if ! identify -quiet "$f" >/dev/null 2>&1; then
              echo "‚ùå Bad texture detected: $f"
              BAD_COUNT=$((BAD_COUNT+1))
            fi
          done
      
          if [ "$BAD_COUNT" -gt 0 ]; then
            echo "‚ùå ERROR: Found $BAD_COUNT corrupted/protected texture files!"
            exit 1
          fi
          # üü¶ END OF INSERTED CHECK üü¶
      
          MERGE_FILE="null"
          if [ "$MERGE_PACK_URL" != "null" ]; then
            echo "‚¨áÔ∏è Downloading merge pack‚Ä¶"
            curl -fSL -o merge_pack.zip "$MERGE_PACK_URL"
      
            if [ ! -s merge_pack.zip ]; then
              echo "‚ùå ERROR: Merge pack file is empty or corrupted!"
              exit 1
            fi
      
            MERGE_FILE="merge_pack.zip"
          fi
      
          echo "üöÄ All good! Starting conversion‚Ä¶"
      
          ./converter.sh input_pack.zip \
            -w "false" \
            -m ${MERGE_FILE} \
            -a ${ATTACHABLE_MATERIAL} \
            -b ${BLOCK_MATERIAL} \
            -f ${DEFAULT_PACK_URL} \
            -v ${DEFAULT_ASSETS_VERSION} \
            -r ${RENAME_MODEL_FILES} \
            -s ${ARCHIVE_SCRATCH} \
            -u "true"


      # Upload
      - uses: actions/upload-artifact@v4
        with:
          name: PackFiles
          path: |
            staging/target/packaged/geyser_resources.mcpack
            staging/target/packaged/geyser_addon.mcaddon
            staging/target/*.json
            staging/target/scratch_files.zip
            staging/config.json

  post-result:
    runs-on: ubuntu-latest
    needs: convert-pack
    timeout-minutes: 20
    permissions:
      issues: write

    steps:
      - name: Post Result
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## :sparkles: The run has finished! :sparkles:
            Download the pack files from [the action run][1].

            [1]: https://github.com/tomzangsad/TOM1/actions/runs/${{ github.run_id}}

      - uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ github.event.issue.number }}

      - uses: actions/download-artifact@v4
        with:
          name: PackFiles
          path: packdata

      - name: Zip PackFiles
        run: |
          cd packdata
          zip -r PackFiles.zip .



      - name: Send Pack to Controller
        id: upload
        continue-on-error: true  # ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ fail ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        run: |
          curl --max-time 1800 --retry 5 --retry-delay 10 \
            -X POST "http://kaizermc.thddns.net:9551/upload_pack" \
            -F "pack=@packdata/PackFiles.zip"


      - name: Notify Controller
        run: |
          curl -X POST "http://kaizermc.thddns.net:9551/notify/convert_done" \
            -H "Content-Type: application/json" \
            -d '{"status":"done"}'
