name: Conversion Request
on:
  issues:
    types:
      - labeled

jobs:
  get-pack-info:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'conversion'
    permissions:
      issues: read
    timeout-minutes: 2

    outputs:
      pack_url:               ${{ steps.organize.outputs.PACK_URL }}
      default_pack_url:       ${{ steps.organize.outputs.DEFAULT_PACK_URL }}
      merge_pack_url:         ${{ steps.organize.outputs.MERGE_PACK_URL }}
      default_assets_version: ${{ steps.organize.outputs.DEFAULT_ASSETS_VERSION }}
      block_material:         ${{ steps.organize.outputs.BLOCK_MATERIAL }}
      attachable_material:    ${{ steps.organize.outputs.ATTACHABLE_MATERIAL }}
      archive_scratch:        ${{ steps.organize.outputs.ARCHIVE_SCRATCH }}
      rename_model_files:     ${{ steps.organize.outputs.RENAME_MODEL_FILES }}
      font_conversion:        ${{ steps.organize.outputs.FONT_CONVERSION }}
      armor_conversion:       ${{ steps.organize.outputs.ARMOR_CONVERSION }}
      meg3_fix:               ${{ steps.organize.outputs.MEG3_FIX }}
      sounds_conversion:      ${{ steps.organize.outputs.SOUNDS_CONVERSION }}
      bow_conversion:         ${{ steps.organize.outputs.BOW_CONVERSION }}
      shield_conversion:      ${{ steps.organize.outputs.SHIELD_CONVERSION }}
      block_conversion:       ${{ steps.organize.outputs.BLOCK_CONVERSION }}

    steps:

      - name: Parse Issue
        id: parse
        uses: zentered/issue-forms-body-parser@v2.2.0

      - name: Organize Inputs
        id: organize
        run: |
          echo '${{ toJSON(steps.parse.outputs.data) }}' | jq '
          def clean($x):
            if ($x == null or $x == "" or $x == "*No response*" or $x == "None")
            then "null"
            else ($x | tostring
                 | gsub("\\r";"")
                 | gsub("\\n";"")
                 | gsub("\"";"")
                 | gsub(" "; ""))
            end;

          {
            PACK_URL:               clean(.["java-pack-direct-download-url"].text),
            DEFAULT_PACK_URL:       clean(.["default-pack-direct-download-url"].text),
            MERGE_PACK_URL:         clean(.["bedrock-merge-pack-direct-download-url"].text),
            DEFAULT_ASSETS_VERSION: clean(.["default-assets-version"].text),
            BLOCK_MATERIAL:         clean(.["block-material"].text),
            ATTACHABLE_MATERIAL:    clean(.["attachable-material"].text),
            ARCHIVE_SCRATCH:        clean(.["archive-scratch-files"].text),
            RENAME_MODEL_FILES:     clean(.["rename-model-files"].text),
            FONT_CONVERSION:        clean(.["font-conversion"].text),
            ARMOR_CONVERSION:       clean(.["armor-conversion"].text),
            MEG3_FIX:               clean(.["meg3-fix"].text),
            SOUNDS_CONVERSION:      clean(.["sounds-conversion"].text),
            BOW_CONVERSION:         clean(.["bow-conversion"].text),
            SHIELD_CONVERSION:      clean(.["shield-conversion"].text),
            BLOCK_CONVERSION:       clean(.["block-conversion"].text)
          }' > out.json

          for key in PACK_URL DEFAULT_PACK_URL MERGE_PACK_URL DEFAULT_ASSETS_VERSION BLOCK_MATERIAL ATTACHABLE_MATERIAL ARCHIVE_SCRATCH RENAME_MODEL_FILES FONT_CONVERSION ARMOR_CONVERSION MEG3_FIX SOUNDS_CONVERSION BOW_CONVERSION SHIELD_CONVERSION BLOCK_CONVERSION; do
            echo "$key=$(jq -r ".[$key]" out.json)" >> $GITHUB_OUTPUT
          done


  convert-pack:
    runs-on: ubuntu-latest
    needs: get-pack-info
    timeout-minutes: 90
    permissions: { contents: read }

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get install -y moreutils zip imagemagick
          yarn global add spritesheet-js
          pip install Pillow requests jproperties

      - name: Convert Pack
        env:
          PACK_URL:               ${{ needs.get-pack-info.outputs.pack_url }}
          MERGE_PACK_URL:         ${{ needs.get-pack-info.outputs.merge_pack_url }}
          DEFAULT_PACK_URL:       ${{ needs.get-pack-info.outputs.default_pack_url }}
          DEFAULT_ASSETS_VERSION: ${{ needs.get-pack-info.outputs.default_assets_version }}
          BLOCK_MATERIAL:         ${{ needs.get-pack-info.outputs.block_material }}
          ATTACHABLE_MATERIAL:    ${{ needs.get-pack-info.outputs.attachable_material }}
          ARCHIVE_SCRATCH:        ${{ needs.get-pack-info.outputs.archive_scratch }}
          RENAME_MODEL_FILES:     ${{ needs.get-pack-info.outputs.rename_model_files }}
          FONT_CONVERSION:        ${{ needs.get-pack-info.outputs.font_conversion }}
          ARMOR_CONVERSION:       ${{ needs.get-pack-info.outputs.armor_conversion }}
          MEG3_FIX:               ${{ needs.get-pack-info.outputs.meg3_fix }}
          SOUNDS_CONVERSION:      ${{ needs.get-pack-info.outputs.sounds_conversion }}
          BOW_CONVERSION:         ${{ needs.get-pack-info.outputs.bow_conversion }}
          SHIELD_CONVERSION:      ${{ needs.get-pack-info.outputs.shield_conversion }}
          BLOCK_CONVERSION:       ${{ needs.get-pack-info.outputs.block_conversion }}

        run: |
          mkdir -p staging
          cp converter.sh staging/
          cd staging
          chmod +x converter.sh

          # Clean URL
          CLEAN_URL=$(echo "$PACK_URL" | tr -d '"')
          echo "Downloading: $CLEAN_URL"

          curl -#L --fail --insecure -o input_pack.zip "$CLEAN_URL"

          MERGE_PACK_FILE="null"
          if [ "$MERGE_PACK_URL" != "null" ]; then
            CLEAN_MERGE=$(echo "$MERGE_PACK_URL" | tr -d '"')
            curl -#L --fail --insecure -o merge_pack.zip "$CLEAN_MERGE"
            MERGE_PACK_FILE="merge_pack.zip"
          fi

          ./converter.sh input_pack.zip -w false -m $MERGE_PACK_FILE -a $ATTACHABLE_MATERIAL -b $BLOCK_MATERIAL -f $DEFAULT_PACK_URL -v $DEFAULT_ASSETS_VERSION -r $RENAME_MODEL_FILES -s $ARCHIVE_SCRATCH -u true


  post-result:
    runs-on: ubuntu-latest
    needs: convert-pack
    permissions:
      issues: write

    steps:
      - name: Done
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            âœ… Conversion completed!
